server {
    listen 80;
    server_name localhost;

    # ðŸš€ Main landing page â€” serve a simple HTML page instead of plain text
    location = / {
        add_header Content-Type text/html;
        return 200 '
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DevOps Lab Services</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2rem;
      background: #f4f6f8;
      color: #333;
    }
    h1 {
      color: #007acc;
    }
    ul {
      list-style-type: none;
      padding-left: 0;
    }
    li {
      margin-bottom: 0.5rem;
    }
    a {
      color: #007acc;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    .services, .quick-access {
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <h1>ðŸš€ DevOps Lab Services</h1>
  <div class="services">
    <h2>ðŸ“Š Available Services:</h2>
    <ul>
      <li><strong>/jenkins</strong> - Jenkins CI/CD Pipeline</li>
      <li><strong>/sonar</strong> - SonarQube Code Quality</li>
      <li><strong>/grafana</strong> - Grafana Monitoring Dashboards</li>
      <li><strong>/prometheus</strong> - Prometheus Metrics Collection</li>
    </ul>
  </div>

  <div class="quick-access">
    <h2>ðŸ”§ Quick Access:</h2>
    <ul>
      <li><a href="http://localhost/jenkins">http://localhost/jenkins</a></li>
      <li><a href="http://localhost/sonar">http://localhost/sonar</a></li>
      <li><a href="http://localhost/grafana">http://localhost/grafana</a></li>
      <li><a href="http://localhost/prometheus">http://localhost/prometheus</a></li>
    </ul>
  </div>
</body>
</html>';
    }

    # Jenkins - supports context path /jenkins
    location /jenkins/ {
        proxy_pass http://jenkins:8080/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Prefix /jenkins;
        proxy_set_header X-Forwarded-Host $host;
        proxy_redirect off;
    }

    # SonarQube - does NOT support sub-paths
    location /sonar/ {
        proxy_pass http://sonarqube:9000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
    }


    # Grafana - does NOT support sub-paths
    location /grafana/ {
        proxy_pass http://grafana:3000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
    }

    # Prometheus - remove prefix before proxying
    location /prometheus/ {
    # Remove /prometheus prefix before proxying
    rewrite ^/prometheus(/.*)$ $1 break;

    proxy_pass http://prometheus:9090/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_redirect off;
}
}
